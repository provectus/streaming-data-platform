AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: Streaming Data Platform, fast and safe way for data streaming
Metadata:
  Authors:
    Description: German Osin (gosin@provectus.com), Rustam Gimadiev (rgimadiev@provectus.com),
      Andrew Saushkin (asaushkin@provectus.com), Astamur Kirillin (akirillin@provectus.com)
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: General Configuration
      Parameters:
      - BufInterval
      - BufSize
      - AggregationPeriod
      - BidsSessionTimeout
      - ShardCount
      - ClicksSessionTimeout
      - LocationsSessionTimeout
      - LogLevel
    ParameterLabels:
    - BufInterval:
        default: Buffering interval
    - BufSize:
        default: Buffering size
    - ShardCount:
        default: Number of Kinesis streams shards
    - AggregationPeriod:
        default: Period of triggering aggreation function
    - BidsSessionTimeout:
        default: Session length (in minutes) for joing bids with impressions
    - ClicksSessionTimeout:
        default: Session length (in minutes) for joing impressions with clicks
    - LocationsSessionTimeout:
        default: Session length (in minutes) for joing locations with clicks and impressions
    - LogLevel:
        default: Default log level in lamdas
Parameters:
  BufInterval:
    Default: 60
    Type: Number
  BufSize:
    Default: 50
    Type: Number
  ShardCount:
    Default: 2
    Type: Number
  AggregationPeriod:
    Default: 10
    Type: Number
  BidsSessionTimeout:
    Default: 5
    Type: Number
  ClicksSessionTimeout:
    Default: 5
    Type: Number
  LocationsSessionTimeout:
    Default: 10
    Type: Number
  LogLevel:
    Default: debug
    Type: String
Rules:
  RegionSupport:
    Assertions:
    - Assert:
        Fn::Contains:
        - - us-east-1
          - us-east-2
          - us-west-2
          - eu-west-1
          - eu-central-1
        - Ref: AWS::Region
      AssertDescription: This stack is only available in the US East (N. Virginia,
        Ohio), US West (Oregon), EU (Ireland and Frankfurt) regions. Please launch
        the stack in one of these regions to continue.
Resources:
  common:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: s3://fdp-itstack-us-west-2/test-1572956606/299f68674492b20a8917ac9e3040f949.template
      Parameters:
        ServicePrefix:
          Ref: AWS::StackName
        AnalyticalDBName:
          Fn::Sub: ${AWS::StackName}-db
        S3BucketName:
          Fn::Sub: sdp-${AWS::StackName}-bucket
        LocationStreamName:
          Fn::Sub: ${AWS::StackName}-locations
  ml:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: s3://fdp-itstack-us-west-2/test-1572956606/c8ab4ced4c9f4c0addbef6b0dfc17c40.template
      Parameters:
        ServicePrefix:
          Ref: AWS::StackName
        S3BucketName:
          Fn::Sub: sdp-${AWS::StackName}-bucket
        AnalyticalDBName:
          Fn::Sub: ${AWS::StackName}-db
        JsonToParquetLambdaArn:
          Fn::GetAtt:
          - common
          - Outputs.JsonToParquetLambdaArn
        LocationsIngestionLambdaArn:
          Fn::GetAtt:
          - common
          - Outputs.LocationsIngestionLambdaArn
        LogLevel:
          Ref: LogLevel
        ShardCount:
          Ref: ShardCount
  processing:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: s3://fdp-itstack-us-west-2/test-1572956606/452e95da8b940fad3d304736a5ea9485.template
      Parameters:
        ServicePrefix:
          Ref: AWS::StackName
        AnalyticalDBName:
          Fn::Sub: ${AWS::StackName}-db
        LocationStreamName: locations
        S3BucketName:
          Fn::GetAtt:
          - ml
          - Outputs.S3BucketName
        BufInterval:
          Ref: BufInterval
        BufSize:
          Ref: BufSize
        ShardCount:
          Ref: ShardCount
        AggregationPeriod:
          Ref: AggregationPeriod
        BidsSessionTimeout:
          Ref: BidsSessionTimeout
        ClicksSessionTimeout:
          Ref: ClicksSessionTimeout
        LocationsSessionTimeout:
          Ref: LocationsSessionTimeout
  injection:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: s3://fdp-itstack-us-west-2/test-1572956606/bf346c4afa65b22a4228f2ca97b4b6a9.template
      Parameters:
        ServicePrefix:
          Ref: AWS::StackName
        BcnStreamName:
          Fn::Sub: ${AWS::StackName}-bcns
        LocationStreamName:
          Fn::Sub: ${AWS::StackName}-locations
  reporting:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: s3://fdp-itstack-us-west-2/test-1572956606/1315c1152a5f7369e30d428b369ca8d7.template
      Parameters:
        ServicePrefix:
          Ref: AWS::StackName
        AggregationDynamoTableName:
          Fn::GetAtt:
          - processing
          - Outputs.AggregationDynamoTableName
Outputs:
  UrlForAPI:
    Description: Root URL of the API gateway
    Value:
      Fn::GetAtt:
      - injection
      - Outputs.UrlForAPI
  UrlForReports:
    Description: Root URL of the reports gateway
    Value:
      Fn::GetAtt:
      - reporting
      - Outputs.UrlForReports
  UrlForPredictions:
    Description: Prediction URL of the API gateway
    Value:
      Fn::GetAtt:
      - ml
      - Outputs.UrlForPredictions
  Bucket:
    Description: S3 bucket with data
    Value:
      Fn::GetAtt:
      - ml
      - Outputs.S3BucketName
